{% load permission_tags %}
<!DOCTYPE html>
<html>
<head>
    <title>Student Management System</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>

<!-- ================= NAVBAR ================= -->
<nav class="navbar navbar-expand-lg navbar-light bg-white px-4">
    {% if request.user.is_authenticated %}
        <button class="btn btn-outline-secondary me-3" id="menu-toggle">
            <i class="bi bi-list"></i>
        </button>
    {% endif %}

    <span class="navbar-brand fw-semibold">Student Management</span>

    <div class="ms-auto">

    {% if request.user.is_authenticated %}

            <div class="dropdown">

                <a class="d-flex align-items-center text-decoration-none dropdown-toggle"
                href="#"
                id="userDropdown"
                data-bs-toggle="dropdown"
                aria-expanded="false">

                    {% if request.user.profile_image %}
                        <img src="{{ request.user.profile_image.url }}"
                            width="38"
                            height="38"
                            class="rounded-circle">
                    {% else %}
                        <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center"
                            style="width:38px; height:38px; font-weight:600;">
                            {{ request.user.first_name|slice:":1"|upper }}
                        </div>
                    {% endif %}

                </a>

                <ul class="dropdown-menu dropdown-menu-end shadow-sm"
                    style="min-width:220px;"
                    aria-labelledby="userDropdown">

                    <li class="px-3 py-2">
                        <div class="fw-semibold">
                            {{ request.user.first_name }} {{ request.user.last_name }}
                        </div>
                        <small class="text-muted">
                            {{ request.user.role.name }}
                        </small>
                    </li>

                    <li><hr class="dropdown-divider"></li>

                    {% if request.user.role.name|lower == "student" %}
                        <li>
                            <a class="dropdown-item"
                            href="{% url 'student_dashboard' %}">
                                <i class="bi bi-speedometer2 me-2"></i>
                                Dashboard
                            </a>
                        </li>
                    {% elif request.user.role.name|lower == "faculty" %}
                        <li>
                            <a class="dropdown-item"
                            href="{% url 'faculty_dashboard' %}">
                                <i class="bi bi-speedometer2 me-2"></i>
                                Dashboard
                            </a>
                        </li>
                    {% elif request.user.role.name|lower == "admin" %}
                        <li>
                            <a class="dropdown-item"
                            href="{% url 'admin_dashboard' %}">
                                <i class="bi bi-speedometer2 me-2"></i>
                                Dashboard
                            </a>
                        </li>
                    {% endif %}

                    <li><hr class="dropdown-divider"></li>

                    <li>
                        <a class="dropdown-item text-danger"
                        href="{% url 'logout' %}">
                            <i class="bi bi-box-arrow-right me-2"></i>
                            Logout
                        </a>
                    </li>

                </ul>

            </div>

        {% else %}

            <a href="{% url 'login' %}" class="btn btn-sm btn-primary me-2">
                Login
            </a>
            <a href="{% url 'register' %}" class="btn btn-sm btn-success">
                Register
            </a>

        {% endif %}

        </div>
        
</nav>

<div class="d-flex" id="wrapper">

    <!-- ================= ADMIN SIDEBAR ================= -->
    {% if request.user.is_authenticated and user.role and user.role.name|lower == "admin" %}
    <div id="sidebar-wrapper">
        <div class="sidebar-heading px-4 py-3">Admin Panel</div>
        <div class="list-group list-group-flush">

            <a href="{% url 'admin_dashboard' %}" class="list-group-item sidebar-link">
                <i class="bi bi-speedometer2 me-2"></i> Dashboard
            </a>

            <a href="{% url 'batch_list' %}" class="list-group-item sidebar-link">
                <i class="bi bi-layers me-2"></i> Manage Batches
            </a>

            <a href="{% url 'admin_student_management' %}" class="list-group-item sidebar-link">
                <i class="bi bi-people me-2"></i> Manage Students
            </a>

            <a href="{% url 'admin_faculty_management' %}" class="list-group-item sidebar-link">
                <i class="bi bi-person-badge me-2"></i> Manage Faculty
            </a>

            <a href="{% url 'course_management' %}" class="list-group-item sidebar-link">
                <i class="bi bi-book me-2"></i> Manage Courses
            </a>

            <a href="{% url 'department_list' %}" class="list-group-item sidebar-link">
                <i class="bi bi-building me-2"></i> Manage Departments
            </a>

            <!-- ðŸ”¥ FIXED: Restored Link -->
            <a href="{% url 'faculty_permission_list' %}" class="list-group-item sidebar-link">
                <i class="bi bi-shield-lock me-2"></i> Manage Faculty Permissions
            </a>

        </div>
    </div>

    <!-- ================= FACULTY SIDEBAR ================= -->
    {% elif request.user.is_authenticated and user.role and user.role.name|lower == "faculty" %}
    <div id="sidebar-wrapper">
        <div class="sidebar-heading px-4 py-3">Faculty Panel</div>
        <div class="list-group list-group-flush">

            <a href="{% url 'faculty_dashboard' %}" class="list-group-item sidebar-link">
                <i class="bi bi-speedometer2 me-2"></i> Dashboard
            </a>

            {% if user|has_permission:"manage_batches" %}
            <a href="{% url 'batch_list' %}" class="list-group-item sidebar-link">
                <i class="bi bi-layers me-2"></i> Manage Batches
            </a>
            {% endif %}

            {% if user|has_permission:"manage_students" %}
            <a href="{% url 'admin_student_management' %}" class="list-group-item sidebar-link">
                <i class="bi bi-people me-2"></i> Manage Students
            </a>
            {% endif %}

            {% if faculty_courses %}
            <a class="list-group-item sidebar-link"
               data-bs-toggle="collapse"
               href="#subjectsMenu">
                <i class="bi bi-book me-2"></i> Subjects
            </a>

            <div class="collapse ps-3" id="subjectsMenu">

                {% for course in faculty_courses %}

                <a class="list-group-item sidebar-link small"
                   data-bs-toggle="collapse"
                   href="#course{{ course.id }}">
                    {{ course.code }} â€“ {{ course.name }}
                </a>

                <div class="collapse ps-3" id="course{{ course.id }}">
                    <a href="{% url 'mark_attendance' course.id %}"
                       class="list-group-item sidebar-link small">
                        Mark Attendance
                    </a>

                    <a href="{% url 'create_quiz' course.id %}"
                       class="list-group-item sidebar-link small">
                        Create Quiz
                    </a>

                    <a href="{% url 'create_exam' course.id %}"
                       class="list-group-item sidebar-link small">
                        Create Exam
                    </a>

                    <a href="{% url 'faculty_timetable' %}"
                       class="list-group-item sidebar-link small">
                        Manage Timetable
                    </a>
                </div>

                {% endfor %}
            </div>
            {% endif %}

        </div>
    </div>

    <!-- ================= STUDENT SIDEBAR ================= -->
    {% elif request.user.is_authenticated and user.role and user.role.name|lower == "student" %}
    <div id="sidebar-wrapper">
        <div class="sidebar-heading px-4 py-3">Student Panel</div>
        <div class="list-group list-group-flush">

            <a href="{% url 'student_dashboard' %}?tab=dashboard" class="list-group-item sidebar-link">
                <i class="bi bi-speedometer2 me-2"></i> Dashboard
            </a>

            <a href="{% url 'student_dashboard' %}?tab=courses" class="list-group-item sidebar-link">
                <i class="bi bi-book me-2"></i> My Courses
            </a>

            <a href="{% url 'student_dashboard' %}?tab=timetable" class="list-group-item sidebar-link">
                <i class="bi bi-calendar3 me-2"></i> Time Table
            </a>

            <a href="{% url 'student_dashboard' %}?tab=attendance" class="list-group-item sidebar-link">
                <i class="bi bi-check2-square me-2"></i> Attendance
            </a>

            <a href="{% url 'student_dashboard' %}?tab=quizzes" class="list-group-item sidebar-link">
                <i class="bi bi-question-circle me-2"></i> Quizzes
            </a>

            <a href="{% url 'student_dashboard' %}?tab=attempts" class="list-group-item sidebar-link">
                <i class="bi bi-bar-chart me-2"></i> Quiz Attempts
            </a>

        </div>
    </div>
    {% endif %}

    <!-- ================= CONTENT ================= -->
    <div id="page-content-wrapper">

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} shadow-sm">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        {% block content %}{% endblock %}

    </div>

</div>

<style>

body {
    font-family: 'Inter', sans-serif;
    background: #f8fafc;
}

/* NAVBAR */
.navbar {
    background: white !important;
    border-bottom: 1px solid #e2e8f0;
}

/* WRAPPER */
#wrapper {
    min-height: 100vh;
}

/* SIDEBAR */
#sidebar-wrapper {
    width: 250px;
    background: white;
    min-height: 100vh;
    border-right: 1px solid #e2e8f0;
}

.sidebar-heading {
    font-size: 14px;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
}

.sidebar-link {
    background: transparent !important;
    color: #334155 !important;
    padding: 10px 20px;
    border-radius: 8px;
    margin: 4px 12px;
    transition: 0.2s ease;
}

.sidebar-link:hover {
    background: #f1f5f9 !important;
    color: #0f172a !important;
}

/* CONTENT */
#page-content-wrapper {
    flex: 1;
    padding: 40px;
}

/* CARD */
.card {
    border: none;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.05);
}

/* TABLE */
.table {
    background: white;
    border-radius: 12px;
    overflow: hidden;
}

.table thead {
    background: #f1f5f9;
}

.btn {
    border-radius: 10px;
}

</style>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
