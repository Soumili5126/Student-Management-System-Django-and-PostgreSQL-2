{% extends "base.html" %}
{% load dict_extras %}
{% block content %}

<h2 class="mb-4">Student Dashboard</h2>

<!-- Student Profile -->
<div class="card mb-4">
    <div class="card-header">
        <strong>My Profile</strong>
    </div>
    <div class="card-body">
        <p><strong>Username:</strong> {{ request.user.username }}</p>
        <p><strong>Roll Number:</strong> {{ student.roll_number }}</p>
        <p><strong>Date of Birth:</strong> {{ student.date_of_birth }}</p>
        <p><strong>Phone:</strong> {{ student.phone }}</p>
        <p><strong>Gender:</strong> {{ student.gender|title }}</p>
        <p><strong>Address:</strong> {{ student.address }}</p>
        <p><strong>Admission Year:</strong> {{ student.admission_year }}</p>
        <!-- ✅ ADD HERE -->
        <p><strong>Batch:</strong>
        {% if student.batch %}
            {{ student.batch.program }} - {{ student.batch.name }}
            ({{ student.batch.academic_year }})
        {% else %}
            <span class="text-muted">Not assigned</span>
        {% endif %}
        </p>
    </div>
</div>

<!-- Academic Performance Overview -->
<div class="card mb-4">
    <div class="card-header">
        <strong>My Performance Overview</strong>
    </div>

    <div class="card-body row text-center">
        <div class="col-md-3">
            <h5>{{ total_exams }}</h5>
            <small class="text-muted">Total Exams</small>
        </div>

        <div class="col-md-3">
            <h5 class="text-success">{{ passed_exams }}</h5>
            <small class="text-muted">Exams Passed</small>
        </div>

        <div class="col-md-3">
            <h5>{{ total_quiz_attempts }}</h5>
            <small class="text-muted">Quiz Attempts</small>
        </div>
    </div>
</div>

<!-- Attendance -->
<div class="card mb-4">
    <div class="card-header">
        <strong>Attendance</strong>
    </div>
    <div class="card-body">

        {% if attendance %}
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Course</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for a in attendance %}
                <tr>
                    <td>{{ a.date }}</td>
                    <td>{{ a.course.name }}</td>
                    <td>
                        {% if a.status == 'present' %}
                            <span class="badge bg-success">Present</span>
                        {% else %}
                            <span class="badge bg-danger">Absent</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p class="text-muted">No attendance records available.</p>
        {% endif %}

    </div>
</div>

<!-- Enrolled Courses -->
<div class="card">
    <div class="card-header">
        <strong>My Courses</strong>
    </div>
    <div class="card-body">
        {% if enrollments %}
        <ul class="list-group">

            {% for enrollment in enrollments %}
               <li class="list-group-item d-flex justify-content-between align-items-center">
                   {{ enrollment.course.code }} — {{ enrollment.course.name }}

                   <span class="badge bg-info">
                     Attendance:
                     {{ attendance_summary|dict_get:enrollment.course.id }}%
                   </span>
                </li>
            {% endfor %}


        </ul>
        {% else %}
            <p class="text-muted">You are not enrolled in any courses.</p>
        {% endif %}
    </div>
</div>
<!--Quizzes-->
<div class="card mt-4">
    <div class="card-header">
        <strong>Available Quizzes</strong>
    </div>

    <div class="card-body">
        {% if quizzes %}
            <ul class="list-group">
                {% for quiz in quizzes %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ quiz.course.code }} — {{ quiz.title }}

                        <a href="{% url 'attempt_quiz' quiz.id %}"
                           class="btn btn-sm btn-primary">
                            Attempt Quiz
                        </a>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted">No quizzes available.</p>
        {% endif %}
    </div>
</div>

<!--Quiz Attempts-->
<div class="card mt-4">
    <div class="card-header">
        <strong>Quiz Attempts</strong>
    </div>

    <div class="card-body">
        {% if quiz_attempts %}
            <ul class="list-group">
                {% for attempt in quiz_attempts %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span>
                            {{ attempt.quiz.title }}<br>
                            <small class="text-muted">
                                {{ attempt.attempted_at|date:"M d, Y H:i" }}
                            </small>
                        </span>

                        <span class="badge bg-info">
                            {{ attempt.score }}/{{ attempt.total_questions }}
                            ({{ attempt.percentage|floatformat:2 }}%)
                        </span>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted">No quiz attempts yet.</p>
        {% endif %}
    </div>
</div>

<!-- Quiz Performance Summary -->
<div class="card mt-4">
    <div class="card-header">
        <strong>Quiz Performance Summary</strong>
    </div>

    <div class="card-body">
        {% if total_quiz_attempts %}
        <ul class="list-group">
            <li class="list-group-item">
                <strong>Average Quiz Score:</strong>
                {{ quiz_summary.avg_score|floatformat:2 }}
            </li>

            {% if best_quiz %}
            <li class="list-group-item text-success">
                <strong>Best Score:</strong>
                {{ best_quiz.score }} / {{ best_quiz.total_questions }}
                ({{ best_quiz.quiz.title }})
            </li>
            {% endif %}

            {% if latest_quiz %}
            <li class="list-group-item text-info">
                <strong>Latest Attempt:</strong>
                {{ latest_quiz.score }} / {{ latest_quiz.total_questions }}
                ({{ latest_quiz.quiz.title }})
            </li>
            {% endif %}
        </ul>
        {% else %}
            <p class="text-muted">No quiz attempts yet.</p>
        {% endif %}
    </div>
</div>


<!-- Exam Results -->
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Exam Results</strong>
        <!-- ✅ PDF EXPORT BUTTON -->
        <a href="{% url 'export_exam_results_pdf' %}"
           class="btn btn-sm btn-outline-danger">
            Export PDF
        </a>
    </div>

    <div class="card-body">
        {% if grades %}
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>Course</th>
                        <th>Exam</th>
                        <th>Marks</th>
                        <th>Total</th>
                        <th>Percentage</th>
                        <th>Grade</th>
                        <th>Result</th>
                    </tr>
                </thead>
                <tbody>
                    {% for g in grades %}
                    <tr>
                        <td>{{ g.exam.course.code }}</td>
                        <td>{{ g.exam.title }}</td>
                        <td>{{ g.marks_obtained }}</td>
                        <td>{{ g.exam.total_marks }}</td>
                        <td>{{ g.percentage|floatformat:2 }}</td>
                        <td> <span class="badge bg-secondary"> {{ g.grade_letter }} </span></td>

                        <td>
                            {% if g.is_pass %}
                            <span class="badge bg-success">Pass</span>
                            {% else %}
                            <span class="badge bg-danger">Fail</span>
                            {% endif %}
                        </td>

                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="text-muted">No exam results available yet.</p>
        {% endif %}
    </div>
</div>

<!-- Exam Performance Chart -->
<div class="card mt-4">
    <div class="card-header">
        <strong>Exam Performance Overview</strong>
    </div>
    <div class="card-body">
        <div class="chart-box">
            <canvas id="examChart"></canvas>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const passed = {{ passed_exams|default:0 }};
    const total = {{ total_exams|default:0 }};
    const failed = Math.max(total - passed, 0);

    const examCanvas = document.getElementById('examChart');
    if (examCanvas) {
        new Chart(examCanvas, {
            type: 'doughnut',
            data: {
                labels: ['Passed', 'Failed'],
                datasets: [{
                    data: [passed, failed],
                    backgroundColor: ['#28a745', '#dc3545']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    });
</script>


{% endblock %}
